<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera and Azure Storage Example</title>
</head>
<body>
    <label for="fileInput" class="custom-file-upload">Capture Image<span id="fileName"></span></label>
    <input type="file" accept="image/*" capture="environment" id="fileInput" style="display: none;" onchange="updateFileName()" multiple>
    <br><br><br><br>

    <script>
        // Updates the file name displayed on the webpage based on the selected file input.
        function updateFileName() {
            var input = document.getElementById('fileInput');
            var fileName = input.value.split('\\').pop();
            document.getElementById('fileName').textContent = " - " + fileName;
        }
        const storageAccountName = 'firstfire';
        const containerName = 'firedoors1';
        sasToken = "?sv=2022-11-02&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2024-06-05T14:08:47Z&st=2024-02-11T05:08:47Z&spr=https,http&sig=RXTEYfSJv1wwz9P6%2BrSJln8scy%2B15cRb8LBFDgWYPCY%3D";

        // Asynchronously uploads an image file to a specified URL using fetch API with error handling and logging.
        async function uploadImage(file) {
            console.log('uploadImage called');
            console.log('file:', file);

            if (file) {
                const blobName = `image_${Date.now()}.jpg`;
                const url = `https://${storageAccountName}.blob.core.windows.net/${containerName}/${blobName}${sasToken}`;

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'x-ms-blob-type': 'BlockBlob',
                            'Content-Type': file.type,
                            'x-ms-version': '2020-04-08'
                        },
                        body: file
                    });

                    if (response.ok) {
                        // your code here...
                    } else {
                        console.log('Upload failed:', response);
                        throw new Error('Upload failed');
                    }
                    console.log('url:', url);
                    return url;
                } catch (error) {
                    console.error('Error during fetch:', error);
                }
            }
        }
                document.querySelector('form[action="/doors"]').addEventListener('submit', function(event) {
                    event.preventDefault();  // Prevent the form from being submitted immediately
                    console.log('form submitted');
                });

                    file = document.querySelector('input[type="file"]').files[0];
                    console.log('file:', file);
                    uploadImage(file).then(function() {
                    // Check if the form exists before trying to submit it
                    document.querySelector('form[action="/doors"]').addEventListener('submit', function(event) {
                        event.preventDefault();  // Prevent the form from being submitted immediately
                        console.log('form submitted');
                    });
                });

                    document.querySelector('input[type="file"]').addEventListener('change', function(event) {
                        file = event.target.files[0];
                        console.log('file:', file);
                        uploadImage(file).then(function() {
                            // Check if the form exists before trying to submit it
                            var formElement = document.querySelector('form[action="/doors"]');
                            if (formElement) {
                                formElement.submit();
                            }
                            // Remove the trailing comma from the imageUrlInput and imageUrls values
                            document.getElementById('imageUrlInput').value = document.getElementById('imageUrlInput').value.slice(0, -1);
                            document.getElementById('imageUrls').value = document.getElementById('imageUrls').value.slice(0, -1);
                            console.log('url:', url);
                            document.getElementById('imageUrlInput').value += url + ',';
                            document.getElementById('imageUrls').value += url + ',';
                            console.log('imageUrlInput:', document.getElementById('imageUrlInput').value);
                            console.log('imageUrls:', document.getElementById('imageUrls').value);
                        });
                    });
    </script>
</body>
<div id="imageUrl"></div>
</html>